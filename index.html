<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AI Question Solver</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <style>
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #f5f7fa;
            --text-color: #333;
            --border-color: #dce1e6;
            --error-color: #d9534f;
            --success-color: #1abc9c;
            --favorite-color: #e91e63;
            --font-family: 'Poppins', sans-serif;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-family);
            background-color: var(--secondary-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
        }
        
        body.menu-active, body.modal-open { overflow: hidden; }

        .container {
            width: 100%;
            max-width: 800px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        header h1 { margin: 0; font-weight: 600; }

        #menu-toggle-btn {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
        }

        /* Side Menu Styles */
        #side-menu { position: fixed; top: 0; left: 0; width: 280px; height: 100%; background-color: #fff; box-shadow: 2px 0 10px rgba(0,0,0,0.1); transform: translateX(-100%); transition: transform 0.3s ease-in-out; z-index: 2000; display: flex; flex-direction: column; }
        #side-menu.open { transform: translateX(0); }
        #menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1999; opacity: 0; pointer-events: none; transition: opacity 0.3s ease-in-out; }
        #menu-overlay.active { opacity: 1; pointer-events: auto; }
        .menu-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding: 20px; }
        .menu-header h2 { font-size: 20px; }
        #close-menu-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #888; }
        .menu-content { padding: 20px; overflow-y: auto; flex-grow: 1; }
        .menu-item { margin-bottom: 12px; }
        .menu-item label { font-weight: 500; display: block; margin-bottom: 8px; }
        .menu-item select, .menu-item button, .menu-item a.menu-button-link { 
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 15px; font-family: var(--font-family); cursor: pointer; background: #f9f9f9; text-align: left;
            display: flex; align-items: center; gap: 10px; text-decoration: none; color: var(--text-color);
        }
        .menu-item button:hover { background-color: #eef; }
        .menu-divider { border-bottom: 1px solid var(--border-color); margin: 15px 0; }
        .cta-button { background-color: var(--success-color) !important; color: white !important; justify-content: center; font-weight: 500;}

        main { padding: 30px; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 8px; }
        #questionInput, #subjectSelect { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-family: var(--font-family); font-size: 16px; transition: border-color 0.3s; }
        #questionInput:focus, #subjectSelect:focus { outline: none; border-color: var(--primary-color); }
        #questionInput { resize: vertical; min-height: 120px; }
        
        .input-options { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; margin-bottom: 20px; }
        .action-buttons { display: flex; gap: 10px; }
        .action-buttons button, .file-input-wrapper {
            width: 44px; height: 44px; border-radius: 50%; border: 1px solid var(--border-color); background-color: #fff; color: #555; font-size: 18px; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: background-color 0.2s, color 0.2s;
        }
        .action-buttons button:hover, .file-input-wrapper:hover { background-color: var(--secondary-color); color: var(--primary-color); }
        #micBtn.is-listening { background-color: var(--error-color); color: white; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%{box-shadow:0 0 0 0 rgba(217,83,79,.7)} 70%{box-shadow:0 0 0 10px rgba(217,83,79,0)} 100%{box-shadow:0 0 0 0 rgba(217,83,79,0)} }
        
        .file-input-wrapper { position: relative; overflow: hidden; }
        .file-input-wrapper input[type="file"] { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        #imagePreview { display: none; max-width: 100%; max-height: 250px; margin: 15px auto; border-radius: 8px; border: 1px solid var(--border-color); }

        #solveBtn { width: 100%; padding: 15px; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: 600; cursor: pointer; transition: background-color 0.3s; }
        #solveBtn:disabled { background-color: #a0c3e8; cursor: not-allowed; }
        #solveBtn:not(:disabled):hover { background-color: #3a7bc8; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-box { background-color: #f2dede; color: var(--error-color); border: 1px solid #ebccd1; padding: 15px; border-radius: 8px; margin-top: 20px; text-align: center; }
        
        #result { margin-top: 30px; padding: 25px; background-color: #f9f9f9; border-radius: 8px; border: 1px solid var(--border-color); }
        .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; }
        .result-header h3 { margin: 0; }
        .result-actions { display: flex; gap: 12px; }
        .result-actions button { background: none; border: 1px solid var(--border-color); color: #555; width: 38px; height: 38px; border-radius: 50%; font-size: 16px; cursor: pointer; transition: all 0.2s; display: flex; justify-content: center; align-items: center; }
        .result-actions button:hover { background-color: var(--secondary-color); color: var(--primary-color); }
        .result-actions button#favoriteBtn.is-favorite { color: var(--favorite-color); }
        .result-actions button.speaking { color: white; background-color: var(--primary-color); }

        #resultContent { line-height: 1.7; word-wrap: break-word; }
        #resultContent * { max-width: 100%; }
        #resultContent code { background-color: #eef; padding: 2px 6px; border-radius: 4px; font-family: monospace; }
        #resultContent pre { background-color: #2d2d2d; color: #f1f1f1; padding: 15px; border-radius: 8px; overflow-x: auto; }
        .hidden { display: none !important; }

        /* Modal Styles */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); display: flex;
            justify-content: center; align-items: center; z-index: 3000;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        .modal.show { opacity: 1; visibility: visible; }
        .modal .modal-content {
            background-color: white; padding: 20px; border-radius: 12px;
            width: 95%; max-width: 700px; max-height: 90vh;
            display: flex; flex-direction: column; box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            position: relative; transform: scale(0.9); transition: transform 0.3s;
        }
        .modal.show .modal-content { transform: scale(1); }
        .modal .close-btn {
            position: absolute; top: 10px; right: 10px; background: #f1f1f1;
            border: none; color: #555; width: 35px; height: 35px;
            border-radius: 50%; font-size: 18px; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
        }
        .modal h2 { margin-bottom: 20px; text-align: center; color: var(--primary-color); }
        
        /* History & Favorites Modal Styles */
        .list-modal ul { list-style: none; padding: 0; max-height: 65vh; overflow-y: auto; }
        .list-item { background-color: #f9f9f9; border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; gap: 15px; }
        .list-item-content { flex-grow: 1; display: flex; align-items: center; gap: 15px; overflow: hidden; cursor: pointer; }
        .list-item-img { width: 50px; height: 50px; object-fit: cover; border-radius: 6px; flex-shrink: 0; }
        .list-item-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .list-item-actions { display: flex; gap: 8px; }
        .list-item-actions button { width: 38px; height: 38px; border-radius: 50%; padding: 0; font-size: 14px; flex-shrink: 0; border: 1px solid var(--border-color); background: white; cursor: pointer; }
        .no-items { text-align: center; padding: 40px 20px; color: #888; }
        #historyModal #downloadHistoryPdfBtn { width: 100%; padding: 12px; margin-bottom: 15px; background: var(--success-color); color: white; border: none; border-radius: 8px; cursor: pointer; }
        
        /* Cropper Modal */
        #cropModal .modal-content { max-width: 90vw; max-height: 90vh; }
        #cropperContainer { height: 60vh; margin-bottom: 20px; background: #eee; }
        #imageToCrop { display: block; max-width: 100%; height: 100%; }
        #cropModal .crop-actions { display:flex; justify-content: flex-end; gap: 10px; }
        #cropModal button { padding: 10px 20px; border-radius: 8px; border: 1px solid var(--border-color); cursor: pointer; font-size: 16px; font-family: var(--font-family); }
        #cropModal #cropBtn { background-color: var(--primary-color); color: white; }
        
        /* Settings Modal */
        .settings-option { margin-bottom: 25px; }
        .settings-option label { font-weight: 500; display: block; margin-bottom: 10px; }
        .settings-option select { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; }
        .text-size-options { display: flex; justify-content: space-between; gap: 10px; }
        .text-size-options input[type="radio"] { display: none; }
        .text-size-options label {
            flex: 1; text-align: center; padding: 10px; border: 1px solid var(--border-color);
            border-radius: 8px; cursor: pointer; transition: all 0.2s ease-in-out;
        }
        .text-size-options input[type="radio"]:checked + label {
            background-color: var(--primary-color); color: white; border-color: var(--primary-color);
        }

        /* Camera Modal Styles */
        #cameraModal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000;
            z-index: 4000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        #cameraVideo { width: 100%; height: 100%; object-fit: cover; }
        #closeCameraBtn {
            position: absolute; top: 20px; right: 20px; z-index: 4002;
            width: 44px; height: 44px; border-radius: 50%; font-size: 20px;
            background-color: rgba(255,255,255,0.2); color: white; border: none;
        }
        .camera-controls {
            position: absolute; bottom: 30px; left: 50%;
            transform: translateX(-50%);
            display: flex; align-items: center; gap: 30px;
            z-index: 4001;
        }
        .camera-controls button {
            width: 60px; height: 60px; border-radius: 50%;
            font-size: 24px; color: white;
            background-color: rgba(255,255,255,0.2);
            border: 2px solid white;
            cursor: pointer;
            display: flex; justify-content: center; align-items: center;
        }
        .camera-controls #captureBtn {
            width: 70px; height: 70px;
            background-color: var(--primary-color);
        }

        @media (max-width: 600px) { body { padding: 0; } .container { border-radius: 0; } main { padding: 20px; } }
    </style>
</head>
<body>
<div id="menu-overlay"></div>

<!-- Side Menu - Contains all navigation -->
<div id="side-menu">
    <div class="menu-header">
        <h2>Menu</h2>
        <button id="close-menu-btn">√ó</button>
    </div>
    <div class="menu-content">
        <div class="menu-item">
            <button id="openSettingsBtn"><i class="fas fa-cog"></i> ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏ (Settings)</button>
        </div>
        <div class="menu-item">
            <button id="openHistoryBtn"><i class="fas fa-history"></i> ‡§â‡§§‡•ç‡§§‡§∞ ‡§á‡§§‡§ø‡§π‡§æ‡§∏</button>
        </div>
        <div class="menu-item">
            <button id="openFavoritesBtn"><i class="fas fa-heart"></i> ‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ ‡§â‡§§‡•ç‡§§‡§∞</button>
        </div>
       
        <div class="menu-divider"></div>

        <div class="menu-item">
            <button class="cta-button" onclick="window.open('https://yadavsir.vercel.app/', '_blank')"><i class="fas fa-user-graduate"></i> YADAV Sir AI ‡§∏‡•á Doubt clear ‡§ï‡§∞‡•á</button>
        </div>
        <div class="menu-item">
             <a href="https://yadav-sir-learn-english-app.vercel.app/#" target="_blank" class="menu-button-link" style="background-color: #007BFF; color: white; justify-content: center; font-weight: 500;">
                <i class="fas fa-book"></i> ‡§á‡§Ç‡§ó‡•ç‡§≤‡§ø‡§∂ ‡§¨‡•ã‡§≤‡§®‡§æ ‡§∏‡•Ä‡§ñ‡•á‡§Ç 30 ‡§¶‡§ø‡§®‡•ã‡§Ç ‡§Æ‡•á‡§Ç
            </a>
        </div>
        <div class="menu-item">
            <button onclick="window.open('https://math-brain-games.vercel.app/', '_blank')"><i class="fas fa-brain"></i> Math BrainGame ‡§¶‡§ø‡§Æ‡§æ‡§ó ‡§§‡•á‡§ú ‡§ï‡§∞‡•á‡§Ç!</button>
        </div>

        <div class="menu-divider"></div>
        
        <div class="menu-item" id="downloadAppContainer">
             <button id="downloadAppBtn"><i class="fas fa-download"></i> ‡§ê‡§™ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç (PWA)</button>
        </div>
        <div class="menu-item">
            <button id="shareAppBtn"><i class="fas fa-share-alt"></i> ‡§ê‡§™ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç</button>
        </div>
        <div class="menu-item">
            <button onclick="window.open('https://yadav-sir-ai-math-gk-solver-rule.vercel.app/', '_blank')"><i class="fas fa-shield-alt"></i> ‡§ó‡•ã‡§™‡§®‡•Ä‡§Ø‡§§‡§æ ‡§®‡•Ä‡§§‡§ø</button>
        </div>

    </div>
</div>

<!-- Cropper Modal -->
<div id="cropModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-bottom: 15px; text-align: center;">Crop Image</h3>
        <div id="cropperContainer">
            <img id="imageToCrop" src="">
        </div>
        <div class="crop-actions">
            <button id="cancelCropBtn">Cancel</button>
            <button id="cropBtn">Crop & Use Image</button>
        </div>
    </div>
</div>

<!-- History Modal -->
<div class="modal list-modal" id="historyModal">
    <div class="modal-content">
        <button class="close-btn" id="closeHistoryBtn"><i class="fas fa-times"></i></button>
        <h2>üìö ‡§â‡§§‡•ç‡§§‡§∞ ‡§á‡§§‡§ø‡§π‡§æ‡§∏</h2>
        <button id="downloadHistoryPdfBtn" title="‡§™‡•Ç‡§∞‡§æ ‡§á‡§§‡§ø‡§π‡§æ‡§∏ PDF ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç">
            <i class="fas fa-file-pdf"></i> ‡§∏‡§≠‡•Ä ‡§á‡§§‡§ø‡§π‡§æ‡§∏ PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç
        </button>
        <ul id="historyList"></ul>
        <p id="no-history" class="no-items hidden">No saved history yet.</p>
    </div>     
</div>

<!-- Favorites Modal -->
<div class="modal list-modal" id="favoritesModal">
    <div class="modal-content">
        <button class="close-btn" id="closeFavoritesBtn"><i class="fas fa-times"></i></button>
        <h2>‚ù§Ô∏è ‡§™‡§∏‡§Ç‡§¶‡•Ä‡§¶‡§æ</h2>
        <ul id="favoritesList"></ul>
        <p id="no-favorites" class="no-items hidden">You have no favorite answers yet.</p>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal" id="settingsModal">
    <div class="modal-content">
        <button class="close-btn" id="closeSettingsBtn"><i class="fas fa-times"></i></button>
        <h2>‚öôÔ∏è ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏</h2>
        <div class="settings-option">
            <label for="languageSelectSettings">‡§â‡§§‡•ç‡§§‡§∞ ‡§ï‡•Ä ‡§≠‡§æ‡§∑‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç:</label>
            <select id="languageSelectSettings"></select>
        </div>
        <div class="settings-option">
            <label>‡§â‡§§‡•ç‡§§‡§∞ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§ï‡§æ ‡§Ü‡§ï‡§æ‡§∞:</label>
            <div class="text-size-options" id="textSizeOptions">
                <input type="radio" id="textSizeSmall" name="textSize" value="14px"><label for="textSizeSmall">‡§õ‡•ã‡§ü‡§æ</label>
                <input type="radio" id="textSizeMedium" name="textSize" value="16px"><label for="textSizeMedium">‡§Æ‡§ß‡•ç‡§Ø‡§Æ</label>
                <input type="radio" id="textSizeLarge" name="textSize" value="18px"><label for="textSizeLarge">‡§¨‡§°‡§º‡§æ</label>
            </div>
        </div>
    </div>
</div>


<!-- Camera Modal -->
<div id="cameraModal">
    <button id="closeCameraBtn"><i class="fas fa-times"></i></button>
    <video id="cameraVideo" autoplay playsinline></video>
    <div class="camera-controls">
        <button id="switchCameraBtn" title="‡§ï‡•à‡§Æ‡§∞‡§æ ‡§¨‡§¶‡§≤‡•á‡§Ç"><i class="fas fa-sync-alt"></i></button>
        <button id="captureBtn" title="‡§´‡•ã‡§ü‡•ã ‡§ñ‡•Ä‡§Ç‡§ö‡§ø‡§è"></button>
        <button id="flashBtn" title="‡§´‡§º‡•ç‡§≤‡•à‡§∂ ‡§ü‡•â‡§ó‡§≤ ‡§ï‡§∞‡•á‡§Ç"><i class="fas fa-bolt"></i></button>
    </div>
</div>

<div class="container">
    <header>
        <button id="menu-toggle-btn">‚ò∞</button>
        <h1>AI Question Solver</h1>
    </header>
    <main>
        <!-- API Key is stored here. Replace with your actual key. -->
        <script id="api-key" type="text/plain">AIzaSyDHy9J04dI8LdK1ijNJMrRXubJ5ucx9rdk</script>

        <div class="form-group">
            <label for="subjectSelect">Select Subject:</label>
            <select id="subjectSelect">
                <option value="math">Math</option>
                <option value="physics">Physics</option>
                <option value="chemistry">Chemistry</option>
                <option value="biology">Biology</option>
                <option value="english">English</option>
                <option value="hindi">Hindi</option>
                <option value="general">General</option>
                <option value="fitnesse">Fitnesse</option>
            </select>
        </div>
        <div class="form-group">
            <label for="questionInput">Enter your question:</label>
            <textarea id="questionInput" placeholder="Type your question here or use the mic..."></textarea>
        </div>
        
        <div class="input-options">
            <div class="action-buttons">
                <button id="micBtn" title="‡§Ö‡§™‡§®‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§¨‡•ã‡§≤‡•á‡§Ç"><i class="fas fa-microphone"></i></button>
                <button id="cameraBtn" title="‡§õ‡§µ‡§ø ‡§ï‡•à‡§™‡•ç‡§ö‡§∞ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§ñ‡•ã‡§≤‡•á‡§Ç"><i class="fas fa-camera"></i></button>
                <button id="clearInputBtn" title="‡§á‡§®‡§™‡•Å‡§ü ‡§î‡§∞ ‡§Ü‡§â‡§ü‡§™‡•Å‡§ü ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç"><i class="fas fa-trash-alt"></i></button>
            </div>
            <div class="file-input-wrapper" title="‡§™‡•Ç‡§õ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§õ‡§µ‡§ø ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç">
                <input type="file" id="imageInput" accept="image/*">
                <i class="fas fa-image"></i>
            </div>
        </div>
        
        <img id="imagePreview" alt="Image Preview">

        <button id="solveBtn">Solve Question</button>
        <div id="loading" class="hidden"><div class="loader"></div></div>
        <div id="error" class="error-box hidden"></div>

        <div id="result" class="hidden">
            <div class="result-header">
                <h3>Solution:</h3>
                <div id="result-actions" class="result-actions">
                    <button id="favoriteBtn" title="Add to favorites"><i class="far fa-heart"></i></button>
                    <button id="shareResultBtn" title="Share result"><i class="fas fa-share-alt"></i></button>
                    <button id="copyResultBtn" title="Copy solution"><i class="fas fa-copy"></i></button>
                    <button id="speakResultBtn" title="Speak solution"><i class="fas fa-volume-up"></i></button>
                    <button id="downloadPdfBtn" title="Download as PDF"><i class="fas fa-file-pdf"></i></button>
                </div>
            </div>
            <div id="resultContent"></div>
        </div>
    </main>
</div>
<script>
class AIQuestionSolverApp {
    constructor() {
        this.apiKey = document.getElementById('api-key').textContent.trim();
        this.uploadedImage = null;
        this.cropper = null;
        this.synth = window.speechSynthesis;
        this.isSpeaking = false;
        this.currentAnswer = { id: null, question: '', image: null, answer: '' };
        this.history = [];
        this.favorites = [];
        this.settings = { language: 'en-US', textSize: '16px' };
        this.deferredInstallPrompt = null; // For PWA installation

        this.languages = [
            { value: 'hi-IN', text: 'üáÆüá≥ ‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)' },          
            { value: 'en-US', text: 'üá∫üá∏ English' },
            { value: 'bn-IN', text: 'üáßüá© ‡§¨‡§Ç‡§ó‡§æ‡§≤‡•Ä (Bengali)' },
            { value: 'mr-IN', text: 'üáÆüá≥ ‡§Æ‡§∞‡§æ‡§†‡•Ä (Marathi)' },
            { value: 'te-IN', text: 'üáÆüá≥ ‡§§‡•á‡§≤‡•Å‡§ó‡•Å (Telugu)' },
            { value: 'ta-IN', text: 'üáÆüá≥ ‡§§‡§Æ‡§ø‡§≤ (Tamil)' },
            { value: 'gu-IN', text: 'üáÆüá≥ ‡§ó‡•Å‡§ú‡§∞‡§æ‡§§‡•Ä (Gujarati)' },
            { value: 'kn-IN', text: 'üáÆüá≥ ‡§ï‡§®‡•ç‡§®‡§°‡§º (Kannada)' },
            { value: 'ml-IN', text: 'üáÆüá≥ ‡§Æ‡§≤‡§Ø‡§æ‡§≤‡§Æ (Malayalam)' },
            { value: 'ur-PK', text: 'üáµüá∞ ‡§â‡§∞‡•ç‡§¶‡•Ç (Urdu)' },
            { value: 'es-ES', text: 'üá™üá∏ ‡§∏‡•ç‡§™‡•á‡§®‡§ø‡§∂ (Spanish)' },
        ];

        // Camera specific state
        this.currentStream = null;
        this.currentFacingMode = 'environment';
        
        this.bindDOMElements();
        this.populateLanguageSelects();
        this.bindEvents();
        this.checkApiKey();
        this.loadSettings();
        this.loadHistory();
        this.loadFavorites();
        this.applySettings();
    }

    bindDOMElements() {
        // Main UI
        this.solveBtn = document.getElementById('solveBtn');
        this.questionInput = document.getElementById('questionInput');
        this.subjectSelect = document.getElementById('subjectSelect');
        this.loadingEl = document.getElementById('loading');
        this.errorEl = document.getElementById('error');
        this.resultEl = document.getElementById('result');
        this.resultContentEl = document.getElementById('resultContent');
        this.imageInput = document.getElementById('imageInput');
        this.imagePreview = document.getElementById('imagePreview');
        
        // Action Buttons
        this.micBtn = document.getElementById('micBtn');
        this.cameraBtn = document.getElementById('cameraBtn');
        this.clearInputBtn = document.getElementById('clearInputBtn');

        // Result Actions
        this.favoriteBtn = document.getElementById('favoriteBtn');
        this.shareResultBtn = document.getElementById('shareResultBtn');
        this.copyResultBtn = document.getElementById('copyResultBtn');
        this.speakResultBtn = document.getElementById('speakResultBtn');
        this.downloadPdfBtn = document.getElementById('downloadPdfBtn');
        
        // Side Menu
        this.menuToggleBtn = document.getElementById('menu-toggle-btn');
        this.closeMenuBtn = document.getElementById('close-menu-btn');
        this.sideMenu = document.getElementById('side-menu');
        this.menuOverlay = document.getElementById('menu-overlay');
        this.shareAppBtn = document.getElementById('shareAppBtn');
        this.downloadAppBtn = document.getElementById('downloadAppBtn');
        this.downloadAppContainer = document.getElementById('downloadAppContainer');
        this.openHistoryBtn = document.getElementById('openHistoryBtn');
        this.openFavoritesBtn = document.getElementById('openFavoritesBtn');
        this.openSettingsBtn = document.getElementById('openSettingsBtn');
        
        // Modals
        this.modals = {
            crop: document.getElementById('cropModal'),
            history: document.getElementById('historyModal'),
            favorites: document.getElementById('favoritesModal'),
            settings: document.getElementById('settingsModal'),
        };
        this.imageToCrop = document.getElementById('imageToCrop');
        this.cropBtn = document.getElementById('cropBtn');
        this.cancelCropBtn = document.getElementById('cancelCropBtn');

        // Camera Modal
        this.cameraModal = document.getElementById('cameraModal');
        this.cameraVideo = document.getElementById('cameraVideo');
        this.closeCameraBtn = document.getElementById('closeCameraBtn');
        this.captureBtn = document.getElementById('captureBtn');
        this.switchCameraBtn = document.getElementById('switchCameraBtn');
        this.flashBtn = document.getElementById('flashBtn');

        // History
        this.historyList = document.getElementById('historyList');
        this.noHistoryMsg = document.getElementById('no-history');
        this.closeHistoryBtn = document.getElementById('closeHistoryBtn');
        this.downloadHistoryPdfBtn = document.getElementById('downloadHistoryPdfBtn');
        
        // Favorites
        this.favoritesList = document.getElementById('favoritesList');
        this.noFavoritesMsg = document.getElementById('no-favorites');
        this.closeFavoritesBtn = document.getElementById('closeFavoritesBtn');

        // Settings
        this.closeSettingsBtn = document.getElementById('closeSettingsBtn');
        this.languageSelectSettings = document.getElementById('languageSelectSettings');
        this.textSizeOptions = document.getElementById('textSizeOptions');

        // Hide PWA button initially
        this.downloadAppContainer.style.display = 'none';
    }

    populateLanguageSelects() {
        [this.languageSelectSettings].forEach(select => {
            if (!select) return;
            select.innerHTML = '';
            this.languages.forEach(lang => {
                const option = document.createElement('option');
                option.value = lang.value;
                option.textContent = lang.text;
                select.appendChild(option);
            });
        });
    }

    bindEvents() {
        // PWA Install Prompt
        window.addEventListener('beforeinstallprompt', (e) => this.captureInstallPrompt(e));
        
        this.solveBtn.addEventListener('click', () => this.solveQuestion());
        this.clearInputBtn.addEventListener('click', () => this.clearAll());
        this.micBtn.addEventListener('click', () => this.handleMicInput());
        this.imageInput.addEventListener('change', (e) => this.handleImageSelection(e.target.files[0]));
        this.cameraBtn.addEventListener('click', () => this.openCamera());
        
        this.favoriteBtn.addEventListener('click', () => this.handleFavoriteClick());
        this.shareResultBtn.addEventListener('click', () => this.shareResult());
        this.copyResultBtn.addEventListener('click', () => this.copyResult());
        this.speakResultBtn.addEventListener('click', () => this.speakResult());
        this.downloadPdfBtn.addEventListener('click', () => this.downloadPdf());

        this.menuToggleBtn.addEventListener('click', () => this.toggleMenu(true));
        this.closeMenuBtn.addEventListener('click', () => this.toggleMenu(false));
        this.menuOverlay.addEventListener('click', () => {
            this.toggleMenu(false);
            Object.keys(this.modals).forEach(key => this.toggleModal(key, false));
        });
        
        this.openHistoryBtn.addEventListener('click', () => this.toggleModal('history', true));
        this.openFavoritesBtn.addEventListener('click', () => this.toggleModal('favorites', true));
        this.openSettingsBtn.addEventListener('click', () => this.toggleModal('settings', true));
        this.shareAppBtn.addEventListener('click', () => this.shareApp());
        this.downloadAppBtn.addEventListener('click', () => this.promptInstall());
        
        this.cropBtn.addEventListener('click', () => this.finalizeCrop());
        this.cancelCropBtn.addEventListener('click', () => this.toggleModal('crop', false));

        this.closeCameraBtn.addEventListener('click', () => this.closeCamera());
        this.captureBtn.addEventListener('click', () => this.captureImage());
        this.switchCameraBtn.addEventListener('click', () => this.switchCamera());
        this.flashBtn.addEventListener('click', () => this.toggleFlash());

        if(this.closeHistoryBtn) this.closeHistoryBtn.addEventListener('click', () => this.toggleModal('history', false));
        if(this.closeFavoritesBtn) this.closeFavoritesBtn.addEventListener('click', () => this.toggleModal('favorites', false));
        if(this.closeSettingsBtn) this.closeSettingsBtn.addEventListener('click', () => this.toggleModal('settings', false));

        this.historyList.addEventListener('click', (e) => this.handleListAction(e, 'history'));
        this.favoritesList.addEventListener('click', (e) => this.handleListAction(e, 'favorites'));
        this.downloadHistoryPdfBtn.addEventListener('click', () => this.downloadAllHistoryPdf());
        
        // Settings Listeners
        this.languageSelectSettings.addEventListener('change', (e) => this.handleLanguageChange(e.target.value));
        this.textSizeOptions.addEventListener('change', (e) => this.handleTextSizeChange(e.target.value));
    }
    
    // --- PWA INSTALLATION METHODS ---
    captureInstallPrompt(e) {
        e.preventDefault();
        this.deferredInstallPrompt = e;
        // Show the install button now that it's possible
        this.downloadAppContainer.style.display = 'block';
    }

    async promptInstall() {
        if (!this.deferredInstallPrompt) {
            alert('‡§Ø‡§π ‡§ê‡§™ ‡§Ö‡§≠‡•Ä ‡§á‡§Ç‡§∏‡•ç‡§ü‡•â‡§≤ ‡§ï‡§∞‡§®‡•á ‡§Ø‡•ã‡§ó‡•ç‡§Ø ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à, ‡§Ø‡§æ ‡§™‡§π‡§≤‡•á ‡§π‡•Ä ‡§á‡§Ç‡§∏‡•ç‡§ü‡•â‡§≤ ‡§π‡•ã ‡§ö‡•Å‡§ï‡§æ ‡§π‡•à‡•§');
            return;
        }
        this.deferredInstallPrompt.prompt();
        const { outcome } = await this.deferredInstallPrompt.userChoice;
        console.log(`User response to the install prompt: ${outcome}`);
        this.deferredInstallPrompt = null; // Prompt can only be used once
        this.downloadAppContainer.style.display = 'none'; // Hide the button after use
    }
    
    checkApiKey() {
        if (!this.apiKey || this.apiKey.includes('AIzaSy') === false) {
            this.showError('CRITICAL: API Key is missing or invalid. Please add your Gemini API key into the HTML file.');
            this.solveBtn.disabled = true;
        }
    }

    async solveQuestion() {
        const question = this.questionInput.value.trim();
        if (!question && !this.uploadedImage) {
            this.showError('Please enter a question or upload an image.');
            return;
        }
        this.setLoading(true);
        this.hideError();
        this.hideResult();

        const subject = this.subjectSelect.value;
        const languageName = this.languages.find(l => l.value === this.settings.language)?.text || 'English';
        const prompt = this.createPrompt(question, subject, languageName);
        
        const model = this.uploadedImage ? 'gemini-pro-vision' : 'gemini-1.5-flash-latest';
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${this.apiKey}`;
        const requestBody = { contents: [{ parts: [] }] };
        requestBody.contents[0].parts.push({ "text": prompt });
        if(this.uploadedImage) {
            requestBody.contents[0].parts.push({ "inline_data": { "mime_type": this.uploadedImage.mimeType, "data": this.uploadedImage.data } });
        }

        try {
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || `HTTP error! Status: ${response.status}`);
            }
            const data = await response.json();
            
            if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
                const content = data.candidates[0].content.parts[0].text;
                this.currentAnswer = { id: Date.now(), question, image: this.uploadedImage, answer: content, subject };
                this.displayResult(content);
                this.addToHistory(this.currentAnswer);
            } else {
                 let reason = 'No content returned from AI.';
                if (data.promptFeedback?.blockReason) reason = `Request blocked. Reason: ${data.promptFeedback.blockReason}`;
                throw new Error(reason);
            }
        } catch (err) {
            console.error('API Error:', err);
            this.showError(`An error occurred: ${err.message}. Check the console for more details.`);
        } finally {
            this.setLoading(false);
        }
    }

    createPrompt(question, subject, language) {
        return `You are an expert AI tutor for the subject: **${subject}**. 
        Solve the following user's question. 
        Provide a clear, step-by-step, and easy-to-understand explanation. 
        Format your answer nicely using Markdown (e.g., use headings, bold text, lists). If the question is complex, break it down into smaller parts.
        Finally, ensure your entire response is in the **${language}** language.
        
        User's Question: "${question}"`;
    }

    setLoading(isLoading) {
        this.loadingEl.classList.toggle('hidden', !isLoading);
        this.solveBtn.disabled = isLoading;
        this.solveBtn.textContent = isLoading ? 'Solving...' : 'Solve Question';
    }
    showError(message) { this.errorEl.textContent = message; this.errorEl.classList.remove('hidden'); }
    hideError() { this.errorEl.classList.add('hidden'); }

    displayResult(content) {
        this.resultContentEl.innerHTML = marked.parse(content);
        this.resultEl.classList.remove('hidden');
        this.updateFavoriteButtonUI();
    }

    hideResult() {
        if(this.isSpeaking) { this.synth.cancel(); }
        this.resultEl.classList.add('hidden');
    }

    clearAll() {
        this.questionInput.value = '';
        this.imageInput.value = '';
        this.imagePreview.style.display = 'none';
        this.imagePreview.src = '';
        this.uploadedImage = null;
        this.currentAnswer = { id: null, question: '', image: null, answer: '' };
        this.hideResult();
        this.hideError();
    }

    toggleMenu(show) {
        this.sideMenu.classList.toggle('open', show);
        this.menuOverlay.classList.toggle('active', show);
        document.body.classList.toggle('menu-active', show);
    }
    
    toggleModal(modalName, show) {
        const modal = this.modals[modalName];
        if (modal) {
            if (show) {
                if(modalName === 'history') this.renderList('history');
                if(modalName === 'favorites') this.renderList('favorites');
                document.body.classList.add('modal-open');
                modal.classList.add('show');
                this.menuOverlay.classList.add('active');
            } else {
                document.body.classList.remove('modal-open');
                modal.classList.remove('show');
                if (!this.sideMenu.classList.contains('open')) {
                    this.menuOverlay.classList.remove('active');
                }
                if (modalName === 'crop' && this.cropper) {
                    this.cropper.destroy();
                    this.cropper = null;
                }
            }
        }
    }
    
    handleImageSelection(file) {
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => this.openCropper(e.target.result);
            reader.readAsDataURL(file);
        }
        this.imageInput.value = '';
    }

    async openCamera() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            alert("Camera not supported on this browser.");
            return;
        }
        this.cameraModal.style.display = 'flex';
        document.body.classList.add('modal-open');
        this.startStream();
    }
    
    async startStream() {
        this.stopStream();
        const constraints = {
            video: { 
                facingMode: this.currentFacingMode,
                width: { ideal: 1920 },
                height: { ideal: 1080 }
            }
        };
        try {
            this.currentStream = await navigator.mediaDevices.getUserMedia(constraints);
            this.cameraVideo.srcObject = this.currentStream;
            
            const track = this.currentStream.getVideoTracks()[0];
            const capabilities = track.getCapabilities();
            this.flashBtn.style.display = capabilities.torch ? 'flex' : 'none';

        } catch (err) {
            console.error("Camera Error:", err);
            alert("Could not access camera. Please check permissions and try again.");
            this.closeCamera();
        }
    }

    closeCamera() {
        this.stopStream();
        this.cameraModal.style.display = 'none';
        document.body.classList.remove('modal-open');
    }
    
    stopStream() {
        if (this.currentStream) {
            this.currentStream.getTracks().forEach(track => track.stop());
            this.currentStream = null;
        }
    }

    captureImage() {
        if (!this.currentStream) return;
        const canvas = document.createElement('canvas');
        canvas.width = this.cameraVideo.videoWidth;
        canvas.height = this.cameraVideo.videoHeight;
        canvas.getContext('2d').drawImage(this.cameraVideo, 0, 0);
        const dataUrl = canvas.toDataURL('image/jpeg');
        
        this.closeCamera();
        this.openCropper(dataUrl);
    }
    
    switchCamera() {
        this.currentFacingMode = this.currentFacingMode === 'environment' ? 'user' : 'environment';
        this.startStream();
    }

    toggleFlash() {
        if (!this.currentStream) return;
        const track = this.currentStream.getVideoTracks()[0];
        try {
            const hasTorch = 'torch' in track.getCapabilities();
            if (hasTorch) {
                const isTorchOn = track.getSettings().torch;
                track.applyConstraints({ advanced: [{ torch: !isTorchOn }] });
            }
        } catch (err) { console.error("Flash Error:", err); }
    }
    
    openCropper(imageSrc) {
        this.imageToCrop.src = imageSrc;
        this.toggleModal('crop', true);
        if (this.cropper) this.cropper.destroy();
        this.cropper = new Cropper(this.imageToCrop, { viewMode: 1, dragMode: 'move', autoCropArea: 0.9, responsive: true });
    }

    finalizeCrop() {
        if (!this.cropper) return;
        const canvas = this.cropper.getCroppedCanvas({ imageSmoothingQuality: 'high' });
        const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
        this.imagePreview.src = dataUrl;
        this.imagePreview.style.display = 'block';
        this.uploadedImage = { mimeType: 'image/jpeg', data: dataUrl.split(',')[1] };
        this.toggleModal('crop', false);
    }

    _getList(type) { return JSON.parse(localStorage.getItem(type)) || []; }
    _saveList(type, data) { localStorage.setItem(type, JSON.stringify(data)); }
    
    loadHistory() { this.history = this._getList('aiSolverHistory_v2'); }
    saveHistory() { this._saveList('aiSolverHistory_v2', this.history); }
    addToHistory(item) { this.history.unshift(item); if (this.history.length > 50) this.history.pop(); this.saveHistory(); }
    
    loadFavorites() { this.favorites = this._getList('aiSolverFavorites_v2'); }
    saveFavorites() { this._saveList('aiSolverFavorites_v2', this.favorites); }
    
    loadSettings() {
        const savedSettings = JSON.parse(localStorage.getItem('aiSolverSettings_v2'));
        if (savedSettings) {
            this.settings = { ...this.settings, ...savedSettings };
        }
    }
    saveSettings() { localStorage.setItem('aiSolverSettings_v2', JSON.stringify(this.settings)); }
    
    applySettings() {
        this.resultContentEl.style.fontSize = this.settings.textSize;
        this.languageSelectSettings.value = this.settings.language;
        const radio = document.querySelector(`#textSizeOptions input[value="${this.settings.textSize}"]`);
        if (radio) radio.checked = true;
    }

    handleLanguageChange(value) {
        this.settings.language = value;
        this.saveSettings();
        this.applySettings();
    }

    handleTextSizeChange(value) {
        this.settings.textSize = value;
        this.saveSettings();
        this.applySettings();
    }

    renderList(type) {
        const list = (type === 'history') ? this.history : this.favorites;
        const listEl = (type === 'history') ? this.historyList : this.favoritesList;
        const noItemsEl = (type === 'history') ? this.noHistoryMsg : this.noFavoritesMsg;

        listEl.innerHTML = '';
        noItemsEl.classList.toggle('hidden', list.length > 0);

        list.forEach(item => {
            const li = document.createElement('li');
            li.className = 'list-item';
            li.dataset.id = item.id;
            li.innerHTML = `
                <div class="list-item-content" data-action="load">
                    ${item.image ? `<img src="data:${item.image.mimeType};base64,${item.image.data}" class="list-item-img" alt="q">` : '<i class="fas fa-comment-dots fa-2x" style="color:#ccc;width:50px;text-align:center;"></i>'}
                    <div class="list-item-text">
                        <strong>${(item.question || 'Image Question').substring(0, 50)}...</strong>
                        <div style="font-size:12px; color:#777;">Subject: ${item.subject || 'N/A'}</div>
                    </div>
                </div>
                <div class="list-item-actions">
                    <button class="action-pdf" title="Download PDF"><i class="fas fa-file-pdf"></i></button>
                    <button class="action-delete" title="Delete"><i class="fas fa-trash-alt"></i></button>
                </div>
            `;
            listEl.appendChild(li);
        });
    }

    handleListAction(e, type) {
        const target = e.target.closest('[data-action], .action-pdf, .action-delete');
        if (!target) return;
        const li = target.closest('.list-item');
        const id = Number(li.dataset.id);
        const action = target.dataset.action || target.classList[0].replace('action-', '');
        
        let list = (type === 'history') ? this.history : this.favorites;
        const item = list.find(h => h.id === id);
        if (!item) return;

        if (action === 'load') {
            this.clearAll();
            this.questionInput.value = item.question;
            this.subjectSelect.value = item.subject;
            if (item.image) {
                this.uploadedImage = item.image;
                this.imagePreview.src = `data:${item.image.mimeType};base64,${item.image.data}`;
                this.imagePreview.style.display = 'block';
            }
            this.currentAnswer = item;
            this.displayResult(item.answer);
            this.toggleModal(type, false);
        } else if (action === 'pdf') {
            this.downloadItemAsPdf(item, `${type}_${item.id}.pdf`);
        } else if (action === 'delete') {
            if (confirm(`Are you sure you want to delete this item from ${type}?`)) {
                if(type === 'history') {
                    this.history = this.history.filter(h => h.id !== id);
                    this.saveHistory();
                    this.renderList(type);
                } else {
                    this.favorites = this.favorites.filter(f => f.id !== id);
                    this.saveFavorites();
                    this.renderList(type);
                }
            }
        }
    }
    
    handleFavoriteClick() {
        if (!this.currentAnswer || !this.currentAnswer.id) {
            alert("There is no answer to add to favorites.");
            return;
        }
        const index = this.favorites.findIndex(fav => fav.id === this.currentAnswer.id);
        if (index > -1) {
            // Remove from favorites
            this.favorites.splice(index, 1);
        } else {
            // Add to favorites
            this.favorites.unshift(this.currentAnswer);
        }
        this.saveFavorites();
        this.updateFavoriteButtonUI();
    }
    
    updateFavoriteButtonUI() {
        const isFav = this.currentAnswer && this.currentAnswer.id && this.favorites.some(fav => fav.id === this.currentAnswer.id);
        this.favoriteBtn.classList.toggle('is-favorite', isFav);
        this.favoriteBtn.innerHTML = isFav ? '<i class="fas fa-heart"></i>' : '<i class="far fa-heart"></i>';
    }

    handleMicInput() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) { alert('Speech Recognition not supported on this browser.'); return; }
        const recognition = new SpeechRecognition();
        recognition.lang = this.settings.language;
        recognition.onstart = () => this.micBtn.classList.add('is-listening');
        recognition.onend = () => this.micBtn.classList.remove('is-listening');
        recognition.onresult = (e) => {
            this.questionInput.value += (this.questionInput.value ? ' ' : '') + e.results[0][0].transcript;
        };
        recognition.onerror = (e) => { console.error('Speech recognition error', e.error); alert(`Mic error: ${e.error}`); };
        recognition.start();
    }

    copyResult() {
        if (!this.currentAnswer.answer) { alert('Nothing to copy.'); return; }
        navigator.clipboard.writeText(this.resultContentEl.innerText).then(() => alert('Solution copied!')).catch(err => alert('Failed to copy.'));
    }

    speakResult() {
        if (!this.synth) { alert('Text-to-speech not supported on this browser.'); return; }
        if (this.isSpeaking) { this.synth.cancel(); return; }
        if (!this.currentAnswer.answer) { alert('Nothing to speak.'); return; }
        
        const utterance = new SpeechSynthesisUtterance(this.resultContentEl.innerText);
        utterance.lang = this.settings.language;
        utterance.onstart = () => { this.isSpeaking = true; this.speakResultBtn.classList.add('speaking'); this.speakResultBtn.innerHTML = '<i class="fas fa-stop-circle"></i>'; };
        utterance.onend = () => { this.isSpeaking = false; this.speakResultBtn.classList.remove('speaking'); this.speakResultBtn.innerHTML = '<i class="fas fa-volume-up"></i>'; };
        utterance.onerror = (e) => { console.error('TTS error:', e); utterance.onend(); };
        this.synth.speak(utterance);
    }
    
    async shareResult() {
        if (!navigator.share) { alert('Share feature is not supported on this browser.'); return; }
        const text = `Question: ${this.currentAnswer.question}\n\nAnswer:\n${this.resultContentEl.innerText}`;
        try {
            await navigator.share({ title: 'AI Solution', text, url: window.location.href });
        } catch (err) {
            console.error('Share error:', err);
        }
    }
    
    async shareApp() {
        if (!navigator.share) { alert('Share feature is not supported on this browser.'); return; }
        try {
            await navigator.share({ title: 'AI Question Solver', text: 'Check out this awesome AI Question Solver app!', url: window.location.href });
        } catch(err) {
            console.error('Share error:', err);
        }
    }
    
    async downloadPdf() {
        if (!this.currentAnswer.answer) { alert('No result to download.'); return; }
        await this.downloadItemAsPdf(this.currentAnswer, 'AI_Solution.pdf');
    }
    
    async downloadAllHistoryPdf() {
        if(this.history.length === 0) { alert("History is empty."); return; }
        alert('Preparing PDF for all history items. This may take a moment...');
        const combinedContent = document.createElement('div');
        this.history.forEach((item, i) => {
            combinedContent.innerHTML += this.createPdfItemHtml(item, `History Item #${i + 1}`);
        });
        await this.generatePdfFromElement(combinedContent, 'AI_Solver_All_History.pdf');
    }

    async downloadItemAsPdf(item, filename) {
        alert('Preparing PDF...');
        const pdfContent = document.createElement('div');
        pdfContent.innerHTML = this.createPdfItemHtml(item, 'Solution');
        await this.generatePdfFromElement(pdfContent, filename);
    }
    
    createPdfItemHtml(item, title) {
        const container = document.createElement('div');
        container.style.cssText = 'padding: 20px; font-family: sans-serif; page-break-after: always;';
        const questionText = item.question ? `<p><strong>Question:</strong> ${item.question}</p>` : '<p><strong>Question:</strong><em> (No text question, see image)</em></p>';
        const imageHtml = item.image ? `<img src="data:${item.image.mimeType};base64,${item.image.data}" style="max-width:100%; border:1px solid #eee; margin-top:10px; margin-bottom:10px;">` : '';
        const answerHtml = marked.parse(item.answer);

        container.innerHTML = `
            <h2 style="color:#333; border-bottom:1px solid #ccc; padding-bottom:5px;">${title}</h2>
            <p><strong>Subject:</strong> ${item.subject || 'N/A'}</p>
            ${questionText}
            ${imageHtml}
            <hr style="margin:20px 0;">
            <h3>Solution:</h3>
            <div style="line-height:1.6;">${answerHtml}</div>`;
        return container.outerHTML;
    }

    async generatePdfFromElement(element, filename) {
        const wrapper = document.createElement('div');
        wrapper.style.cssText = 'width: 700px; position: absolute; left: -9999px; top: 0; background-color: white; padding: 10px;';
        wrapper.appendChild(element.cloneNode(true));
        document.body.appendChild(wrapper);
        
        try {
            const { jsPDF } = window.jspdf;
            const appUrl = window.location.href;

            const addHeaderAndFooter = (pdfInstance) => {
                const pageCount = pdfInstance.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    pdfInstance.setPage(i);
                    const pdfWidth = pdfInstance.internal.pageSize.getWidth();
                    const pdfHeight = pdfInstance.internal.pageSize.getHeight();
                    pdfInstance.setFontSize(16);
                    pdfInstance.setFont('helvetica', 'bold');
                    pdfInstance.text('All Doubt Solver', pdfWidth / 2, 15, { align: 'center' });
                    pdfInstance.setFontSize(10);
                    pdfInstance.setFont('helvetica', 'normal');
                    pdfInstance.setTextColor(0, 0, 255);
                    const footerText = '1 ‡§Æ‡§ø‡§®‡§ü ‡§Æ‡•á all doubt solver kare ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á';
                    pdfInstance.textWithLink(footerText, pdfWidth / 2, pdfHeight - 10, { url: appUrl, align: 'center' });
                    pdfInstance.setTextColor(0, 0, 0);
                }
            };

            const canvas = await html2canvas(wrapper, { scale: 2, useCORS: true });
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const topMargin = 25;
            const bottomMargin = 20;
            const contentWidth = pdfWidth - 20;
            const contentHeight = pdfHeight - topMargin - bottomMargin;
            const imgProps = pdf.getImageProperties(canvas);
            const totalImgHeight = (imgProps.height * contentWidth) / imgProps.width;

            let heightLeft = totalImgHeight;
            let position = 0;

            pdf.addImage(canvas, 'PNG', 10, topMargin, contentWidth, totalImgHeight);
            heightLeft -= contentHeight;

            while (heightLeft > 0) {
                position -= contentHeight;
                pdf.addPage();
                pdf.addImage(canvas, 'PNG', 10, position + topMargin, contentWidth, totalImgHeight);
                heightLeft -= contentHeight;
            }

            addHeaderAndFooter(pdf);
            pdf.save(filename);
            alert('PDF downloaded successfully!');

        } catch (error) { 
            console.error("PDF Generation Error:", error); 
            alert("Sorry, failed to create the PDF. Please try again."); 
        } finally { 
            document.body.removeChild(wrapper); 
        }
    }
}

document.addEventListener('DOMContentLoaded', () => { new AIQuestionSolverApp(); });
</script>
</body>
</html>